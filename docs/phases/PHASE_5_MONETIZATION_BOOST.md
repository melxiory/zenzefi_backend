# Phase 5: Monetization Boost

**–í–µ—Ä—Å–∏—è:** v0.7.0-beta
**–°—Ç–∞—Ç—É—Å:** Sprint 1 ‚úÖ –ó–ê–í–ï–†–®–Å–ù, Sprints 2-3 üìã –ü–õ–ê–ù–ò–†–£–Æ–¢–°–Ø
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Sprint 1:** 3 –¥–Ω—è (19-21 Nov 2025)
**–¢–µ—Å—Ç—ã:** 208/208 (+34 –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–∞, 85%+ –ø–æ–∫—Ä—ã—Ç–∏–µ)

---

## üìã –û–±–∑–æ—Ä Phase 5

Phase 5 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ **—É—Å–∫–æ—Ä–µ–Ω–∏–µ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏** –∏ **–≤–∏—Ä—É—Å–Ω—ã–π —Ä–æ—Å—Ç** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –±–∞–∑—ã —á–µ—Ä–µ–∑:

### Sprint 1: Token Bundles + Referral System ‚úÖ –ó–ê–í–ï–†–®–Å–ù (3 –¥–Ω—è)
- **Token Bundles** - –ü–∞–∫–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å–æ —Å–∫–∏–¥–∫–∞–º–∏ 10-20%
- **Referral System** - 10% bonus –æ—Ç –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ >100 ZNC

### Sprint 2: Auto-Renewal + Gifting üìã –ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–ù (8-10 –¥–Ω–µ–π)
- **Token Auto-Renewal** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π
- **Token Gifting** - –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –¥—Ä—É–∑—å—è–º (social sharing)

### Sprint 3: Loyalty + Promo Codes üìã –ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–ù (8-10 –¥–Ω–µ–π)
- **Loyalty Tiers** - Bronze/Silver/Gold —Å –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–º–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏
- **Promo Codes** - –î–∏—Å–∫–æ–Ω—Ç–Ω—ã–µ –∫–æ–¥—ã –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π

---

## Sprint 1: Token Bundles + Referral System

### üéØ –¶–µ–ª–∏ Sprint 1

1. **–£–≤–µ–ª–∏—á–∏—Ç—å ARPU (Average Revenue Per User)** —á–µ—Ä–µ–∑ –ø–∞–∫–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
2. **–£—Å–∫–æ—Ä–∏—Ç—å –≤–∏—Ä—É—Å–Ω—ã–π —Ä–æ—Å—Ç** —á–µ—Ä–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É
3. **–°–Ω–∏–∑–∏—Ç—å friction –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ** (bundles –ø—Ä–æ—â–µ, —á–µ–º –ø–æ–∫—É–ø–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É)
4. **–°–æ–∑–¥–∞—Ç—å incentive –¥–ª—è sharing** (referral bonus –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –¥—Ä—É–∑–µ–π)

### üìä –û–∂–∏–¥–∞–µ–º—ã–π Impact

- **Token Bundles:** +75-120% revenue (bulk purchases drive higher ARPU)
- **Referral System:** +30-50% user acquisition (viral growth)
- **Combined Impact:** +105-170% total revenue potential

---

## Feature 1: Token Bundles

### –û–±–∑–æ—Ä

**Token Bundles** - —ç—Ç–æ –ø–∞–∫–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø–æ–∑–≤–æ–ª—è—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–∫—É–ø–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ —Å—Ä–∞–∑—É —Å–æ —Å–∫–∏–¥–∫–æ–π. –ß–µ–º –±–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ø–∞–∫–µ—Ç–µ, —Ç–µ–º –≤—ã—à–µ —Å–∫–∏–¥–∫–∞ (progressive discounts).

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

**–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- –≠–∫–æ–Ω–æ–º–∏—è 10-25% –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø–æ–∫—É–ø–∫–æ–π —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É
- –£–¥–æ–±—Å—Ç–≤–æ (–æ–¥–∏–Ω –∫–ª–∏–∫ –≤–º–µ—Å—Ç–æ 10-50 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫)
- –ü–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è

**–î–ª—è –±–∏–∑–Ω–µ—Å–∞:**
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ ARPU (—Å—Ä–µ–¥–Ω–µ–π –≤—ã—Ä—É—á–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- –°–Ω–∏–∂–µ–Ω–∏–µ friction (–º–µ–Ω—å—à–µ —Ä–µ—à–µ–Ω–∏–π –æ –ø–æ–∫—É–ø–∫–µ)
- Cash flow –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å (bulk purchases upfront)
- –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç (bundles –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –∫–∞–∫ –≤—ã–≥–æ–¥–∞)

### Database Model: TokenBundle

**–§–∞–π–ª:** `app/models/bundle.py`

```python
class TokenBundle(Base):
    __tablename__ = "token_bundles"

    # Primary fields
    id: UUID (primary key)
    name: str (255, not null)                  # "Starter Pack"
    description: str (text, nullable)          # "5 tokens for beginners - 10% off"
    token_count: int (not null)                # Number of tokens in bundle (e.g., 5)
    duration_hours: int (not null)             # Duration for each token (e.g., 24)
    scope: str (50, not null, default="full")  # Scope for each token

    # Pricing
    discount_percent: Decimal(5, 2) (not null) # Discount percentage (e.g., 10.00 = 10%)
    base_price: Decimal(10, 2) (not null)      # Total price without discount
    total_price: Decimal(10, 2) (not null)     # Final price after discount

    # Status
    is_active: bool (default=True, indexed)    # Soft delete flag

    # Timestamps
    created_at: datetime (not null, timezone-aware)
    updated_at: datetime (nullable, timezone-aware)

    # Computed properties (NOT stored in DB)
    @property
    def savings(self) -> Decimal:
        """Calculate total savings (base_price - total_price)"""
        return self.base_price - self.total_price

    @property
    def price_per_token(self) -> Decimal:
        """Calculate price per token in bundle"""
        return self.total_price / Decimal(self.token_count)
```

**Indexes:**
- `ix_token_bundles_is_active` - –î–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö bundles

**Migration:** `alembic/versions/add_bundles_table.py`

### Default Bundles

4 –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö bundle –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

| Bundle | Tokens | Duration | Base Price | Total Price | Discount | Savings | Use Case |
|--------|--------|----------|------------|-------------|----------|---------|----------|
| **Starter Pack** | 5 | 24h | 90 ZNC | 81 ZNC | 10% | 9 ZNC | –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, trial |
| **Developer Pack** | 10 | 7d | 1000 ZNC | 850 ZNC | 15% | 150 ZNC | –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏, —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
| **Team Pack** | 25 | 7d | 2500 ZNC | 2000 ZNC | 20% | 500 ZNC | –ö–æ–º–∞–Ω–¥—ã, —Å–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ |
| **Enterprise Pack** | 50 | 30d | 15000 ZNC | 11250 ZNC | 25% | 3750 ZNC | –ö—Ä—É–ø–Ω—ã–π –±–∏–∑–Ω–µ—Å, long-term usage |

**–†–∞—Å—á–µ—Ç —Ü–µ–Ω:**
- **Base Price** = token_count √ó token_price
  - Starter: 5 √ó 18 ZNC = 90 ZNC (5√ó24h)
  - Developer: 10 √ó 100 ZNC = 1000 ZNC (10√ó7d)
  - Team: 25 √ó 100 ZNC = 2500 ZNC (25√ó7d)
  - Enterprise: 50 √ó 300 ZNC = 15000 ZNC (50√ó30d)
- **Total Price** = base_price √ó (1 - discount_percent/100)

### Service: BundleService

**–§–∞–π–ª:** `app/services/bundle_service.py`

**–û–ø–µ—Ä–∞—Ü–∏–∏:**

1. **get_available_bundles(db, active_only=True)** ‚Üí List[TokenBundle]
   - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö bundles
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: `is_active=True` (–µ—Å–ª–∏ active_only)
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ token_count (–æ—Ç –º–µ–Ω—å—à–µ–≥–æ –∫ –±–æ–ª—å—à–µ–º—É)

2. **get_bundle_by_id(db, bundle_id)** ‚Üí TokenBundle
   - –ü–æ–ª—É—á–∏—Ç—å bundle –ø–æ ID
   - –ü—Ä–æ–≤–µ—Ä–∫–∞: bundle exists AND is_active
   - Raises: HTTPException 404 –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω

3. **purchase_bundle(bundle_id, user_id, db)** ‚Üí dict
   - **–ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ–∫—É–ø–∫–∏ bundle:**
     1. –ü—Ä–æ–≤–µ—Ä–∫–∞: bundle exists AND is_active
     2. –ü—Ä–æ–≤–µ—Ä–∫–∞: user exists
     3. –ü—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å (with_for_update row lock)
     4. –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (user.currency_balance -= bundle.total_price)
     5. –°–æ–∑–¥–∞–Ω–∏–µ PURCHASE transaction
     6. **–°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–æ–∫–µ–Ω–æ–≤ –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è** (create_token_without_charge)
     7. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ referral bonus (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
     8. Commit —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - Raises: HTTPException 402 –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞
   - **CRITICAL:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `TokenService.create_token_without_charge()` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è

4. **create_bundle(db, **kwargs)** ‚Üí TokenBundle (superuser only)
   - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π bundle
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: name, description, token_count, duration_hours, scope, discount_percent, base_price, total_price, is_active

5. **update_bundle(db, bundle_id, **kwargs)** ‚Üí TokenBundle (superuser only)
   - –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π bundle
   - –í—Å–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã (partial update)

6. **delete_bundle(db, bundle_id)** ‚Üí bool (superuser only)
   - **Soft delete:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `is_active=False`
   - Bundle –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –ë–î –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫—É–ø–æ–∫

### API Endpoints: /api/v1/bundles

**Public Endpoints (no auth required):**

1. **GET /api/v1/bundles**
   - –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö bundles
   - Query params:
     - `active_only` (bool, default=True) - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
   - Response:
```json
{
  "items": [
    {
      "id": "uuid",
      "name": "Starter Pack",
      "description": "5 tokens for beginners - 10% off",
      "token_count": 5,
      "duration_hours": 24,
      "scope": "full",
      "discount_percent": "10.00",
      "base_price": "90.00",
      "total_price": "81.00",
      "savings": "9.00",
      "price_per_token": "16.20",
      "is_active": true,
      "created_at": "2025-11-19T...",
      "updated_at": null
    }
  ]
}
```

2. **GET /api/v1/bundles/{bundle_id}**
   - –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π bundle –ø–æ ID
   - Raises: 404 –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
   - Response: Same as list item

**Authenticated Endpoints (JWT required):**

3. **POST /api/v1/bundles/{bundle_id}/purchase**
   - –ö—É–ø–∏—Ç—å bundle
   - Headers: `Authorization: Bearer {jwt_token}`
   - Response:
```json
{
  "bundle_name": "Starter Pack",
  "tokens_generated": 5,
  "cost_znc": "81.00",
  "new_balance": "119.00",
  "tokens": [
    {
      "id": "uuid",
      "token": "64-char-string",
      "duration_hours": 24,
      "scope": "full",
      "activated_at": null,
      "expires_at": null,
      "is_active": true,
      "created_at": "2025-11-19T..."
    }
  ]
}
```
   - Errors:
     - 401: Not authenticated
     - 402: Insufficient balance
     - 404: Bundle not found or inactive

**Admin Endpoints (superuser required):**

4. **POST /api/v1/bundles**
   - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π bundle
   - Body:
```json
{
  "name": "Custom Bundle",
  "description": "Custom description",
  "token_count": 10,
  "duration_hours": 168,
  "scope": "full",
  "discount_percent": "15.00",
  "base_price": "1000.00",
  "total_price": "850.00",
  "is_active": true
}
```
   - Response: Created bundle object
   - Status: 201 Created

5. **PATCH /api/v1/bundles/{bundle_id}**
   - –û–±–Ω–æ–≤–∏—Ç—å bundle (partial update)
   - Body: Any subset of create fields
   - Response: Updated bundle object

6. **DELETE /api/v1/bundles/{bundle_id}**
   - Soft delete bundle (set is_active=False)
   - Response: 204 No Content

### Token Creation Fix: create_token_without_charge()

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ bundle –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –¥–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:
1. BundleService —Å–ø–∏—Å—ã–≤–∞–µ—Ç total_price
2. TokenService.generate_access_token() –µ—â—ë —Ä–∞–∑ —Å–ø–∏—Å—ã–≤–∞–µ—Ç price –∑–∞ –∫–∞–∂–¥—ã–π —Ç–æ–∫–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:** –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `TokenService.create_token_without_charge()`

**–§–∞–π–ª:** `app/services/token_service.py`

```python
@staticmethod
def create_token_without_charge(
    user_id: UUID,
    duration_hours: int,
    scope: str,
    db: Session
) -> dict:
    """
    Create access token WITHOUT balance deduction.

    Used by BundleService to create tokens after bundle purchase
    (balance already deducted for entire bundle).
    """
    token_string = secrets.token_urlsafe(48)  # 64 chars
    now = datetime.now(timezone.utc)

    db_token = AccessToken(
        user_id=str(user_id),
        token=token_string,
        duration_hours=duration_hours,
        scope=scope,
        created_at=now,
        activated_at=None,  # Lazy activation
        is_active=True,
    )

    db.add(db_token)
    db.flush()  # Get ID without committing
    db.refresh(db_token)

    return {
        "id": str(db_token.id),
        "token": db_token.token,
        "duration_hours": db_token.duration_hours,
        "scope": db_token.scope,
        "activated_at": None,
        "expires_at": None,
        "is_active": db_token.is_active,
        "created_at": db_token.created_at.isoformat()
    }
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ BundleService:**
```python
for _ in range(bundle.token_count):
    token = TokenService.create_token_without_charge(
        user_id=user.id,
        duration_hours=bundle.duration_hours,
        scope=bundle.scope,
        db=db
    )
    tokens.append(token)
```

### Decimal Serialization Fix

**–ü—Ä–æ–±–ª–µ–º–∞:** Pydantic v2 —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç Decimal –∫–∞–∫ string –≤ JSON –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏. –¢–µ—Å—Ç—ã –æ–∂–∏–¥–∞–ª–∏ float, –Ω–æ –ø–æ–ª—É—á–∞–ª–∏ string.

**–†–µ—à–µ–Ω–∏–µ:**

1. **BundleService:** –í–æ–∑–≤—Ä–∞—â–∞—Ç—å Decimal values –Ω–∞–ø—Ä—è–º—É—é (–ù–ï –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ float)
```python
# ‚ùå –ë–´–õ–û:
"cost_znc": float(bundle.total_price),

# ‚úÖ –°–¢–ê–õ–û:
"cost_znc": bundle.total_price,  # Pydantic —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –≤ string
```

2. **API Endpoints:** –°–æ—Ö—Ä–∞–Ω–∏—Ç—å Decimal values (—É–¥–∞–ª–∏—Ç—å float() conversions)
```python
# ‚ùå –ë–´–õ–û:
"total_price": float(b.total_price),

# ‚úÖ –°–¢–ê–õ–û:
"total_price": b.total_price,  # Pydantic —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –≤ string
```

3. **Tests:** –û–±–Ω–æ–≤–∏—Ç—å assertions –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Decimal –≤ JSON
```python
# Service tests (Decimal comparison)
assert result["cost_znc"] == Decimal("81.00")

# API tests (convert from JSON string)
assert Decimal(data["cost_znc"]) == Decimal("81.00")
```

### Tests: test_bundles.py

**–§–∞–π–ª:** `tests/test_bundles.py`
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:** 20 —Ç–µ—Å—Ç–æ–≤

**Test Classes:**

1. **TestBundleModel** (3 tests)
   - `test_bundle_model_creation` - –°–æ–∑–¥–∞–Ω–∏–µ TokenBundle
   - `test_bundle_savings_property` - Computed property savings
   - `test_bundle_price_per_token_property` - Computed property price_per_token

2. **TestBundleService** (14 tests)
   - `test_get_available_bundles` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö bundles
   - `test_get_all_bundles_including_inactive` - –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö bundles
   - `test_get_bundle_by_id_success` - –ü–æ–ª—É—á–µ–Ω–∏–µ bundle –ø–æ ID
   - `test_get_bundle_by_id_inactive_raises_404` - 404 –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö
   - `test_get_bundle_by_id_nonexistent_raises_404` - 404 –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
   - `test_purchase_bundle_success` - –£—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ bundle
   - `test_purchase_bundle_insufficient_balance` - 402 –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ
   - `test_purchase_bundle_inactive_raises_404` - 404 –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ bundle
   - `test_purchase_bundle_user_not_found` - 404 –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ user
   - `test_create_bundle` - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ bundle
   - `test_update_bundle` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ bundle
   - `test_delete_bundle_soft_delete` - Soft delete bundle

3. **TestBundleAPI** (3 tests)
   - `test_list_bundles_endpoint` - GET /bundles
   - `test_get_bundle_by_id_endpoint` - GET /bundles/{id}
   - `test_purchase_bundle_endpoint_success` - POST /bundles/{id}/purchase (success)
   - `test_purchase_bundle_endpoint_no_auth` - 403 –±–µ–∑ JWT
   - `test_purchase_bundle_endpoint_insufficient_balance` - 402 –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ

**Test Coverage:** 100% –¥–ª—è BundleService –∏ API endpoints

---

## Feature 2: Referral System

### –û–±–∑–æ—Ä

**Referral System** - —ç—Ç–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞—Ç—å **10% bonus** –æ—Ç –∏—Ö –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏ >100 ZNC.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

**–î–ª—è —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤ (inviter):**
- –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ (10% –æ—Ç –ø–æ–∫—É–ø–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤)
- Incentive –¥–ª—è sharing (–º–æ—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏–≤–æ–¥–∏—Ç—å –¥—Ä—É–∑–µ–π)
- Tracking –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤)

**–î–ª—è —Ä–µ—Ñ–µ—Ä–∏ (referee):**
- –ù–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (bonus –¥–ª—è referrer, –Ω–µ –¥–ª—è referee)
- –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (optional referral code –ø—Ä–∏ sign-up)

**–î–ª—è –±–∏–∑–Ω–µ—Å–∞:**
- –í–∏—Ä—É—Å–Ω—ã–π —Ä–æ—Å—Ç (user acquisition —á–µ—Ä–µ–∑ existing users)
- –ù–∏–∑–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è (10% bonus –¥–µ—à–µ–≤–ª–µ –ø–ª–∞—Ç–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã)
- –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è (referred users –±–æ–ª–µ–µ engaged)
- Anti-abuse protection (—Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞ >100 ZNC)

### Database Model: User (extended)

**–§–∞–π–ª:** `app/models/user.py`

**–ù–æ–≤—ã–µ –ø–æ–ª—è:**

```python
class User(Base):
    # Existing fields...

    # Referral fields (added in Phase 5)
    referral_code: str (12, unique, not null, indexed)  # "ABC123XYZ456"
    referred_by_id: UUID (FK to users.id, nullable, indexed)  # Who referred this user
    referral_bonus_earned: Decimal(10, 2) (default=0.00, not null)  # Total bonus earned from referrals

    # Relationships
    referred_by: User (many-to-one, self-referential)  # Referrer
    referred_users: List[User] (one-to-many, self-referential)  # Referees
```

**Indexes:**
- `ix_users_referral_code` - –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ referral code
- `ix_users_referred_by_id` - –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ referees

**Migration:** `alembic/versions/add_referral_fields.py`

### Referral Code Format

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- **–î–ª–∏–Ω–∞:** 12 —Å–∏–º–≤–æ–ª–æ–≤
- **Charset:** Alphanumeric uppercase (A-Z, 0-9)
- **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ UNIQUE constraint + collision retry logic
- **–ü—Ä–∏–º–µ—Ä:** `ABC123XYZ456`, `Q7R8S9T0U1V2`

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è:** `AuthService.generate_referral_code(db)`

```python
@staticmethod
def generate_referral_code(db: Session, max_attempts: int = 100) -> str:
    """
    Generate unique 12-character referral code.

    Format: Alphanumeric uppercase (A-Z, 0-9)
    Example: ABC123XYZ456

    Collision handling: Retry up to max_attempts if code exists
    """
    charset = string.ascii_uppercase + string.digits  # A-Z + 0-9

    for attempt in range(max_attempts):
        code = ''.join(secrets.choice(charset) for _ in range(12))

        # Check if code already exists
        existing = db.query(User).filter(User.referral_code == code).first()
        if not existing:
            return code

    # Should never happen with 36^12 possible codes
    raise ValueError("Failed to generate unique referral code")
```

**Collision Probability:**
- Total possible codes: 36^12 = 4.7 √ó 10^18
- Probability of collision with 1M users: ~0.00001%

### Registration with Referral Code

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:**

```python
# app/services/auth_service.py
@staticmethod
def register_user(user_data: UserCreate, db: Session, referral_code: str = None) -> User:
    """
    Register new user with optional referral code.

    Steps:
    1. Validate referral code (if provided)
    2. Create user with generated referral code
    3. Set referred_by_id relationship
    4. Return created user
    """
    # 1. Validate referral code (if provided)
    referrer = None
    if referral_code:
        referrer = db.query(User).filter(User.referral_code == referral_code).first()
        if not referrer:
            raise ValueError(f"Invalid referral code: {referral_code}")

    # 2. Create user
    db_user = User(
        email=user_data.email,
        username=user_data.username,
        hashed_password=hash_password(user_data.password),
        full_name=user_data.full_name,
        referral_code=AuthService.generate_referral_code(db),  # Unique code
        referred_by_id=referrer.id if referrer else None,
        referral_bonus_earned=Decimal("0.00"),
        currency_balance=Decimal("0.00"),
        is_active=True,
        is_superuser=False,
    )

    db.add(db_user)
    db.commit()
    db.refresh(db_user)

    return db_user
```

### Referral Bonus Logic

**–ü—Ä–∞–≤–∏–ª–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è bonus:**

1. **Threshold:** –ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞ >100 ZNC
2. **Amount:** 10% –æ—Ç —Å—É–º–º—ã –ø–æ–∫—É–ø–∫–∏
3. **Frequency:** –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞ (prevent abuse)
4. **Trigger:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ token/bundle purchase

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `CurrencyService.award_referral_bonus()`

```python
@staticmethod
def award_referral_bonus(
    referee_id: UUID,
    purchase_amount: Decimal,
    db: Session
) -> Optional[Decimal]:
    """
    Award referral bonus to referrer if conditions met.

    Conditions:
    1. Referee was referred by someone (referred_by_id is set)
    2. Purchase amount > 100 ZNC
    3. This is referee's first qualifying purchase

    Returns:
        Decimal: Bonus amount awarded (or None if not awarded)
    """
    # Get referee
    referee = db.query(User).filter(User.id == referee_id).first()
    if not referee or not referee.referred_by_id:
        return None  # Not referred by anyone

    # Check purchase amount
    if purchase_amount <= Decimal("100.00"):
        return None  # Below threshold

    # Check if referrer already received bonus from this referee
    existing_bonus = db.query(Transaction).filter(
        Transaction.user_id == referee.referred_by_id,
        Transaction.transaction_type == TransactionType.REFERRAL_BONUS,
        Transaction.description.like(f"%{referee.username}%")
    ).first()

    if existing_bonus:
        return None  # Bonus already awarded

    # Calculate bonus (10%)
    bonus = purchase_amount * Decimal("0.10")

    # Award bonus to referrer
    referrer = db.query(User).filter(User.id == referee.referred_by_id).with_for_update().first()
    referrer.currency_balance += bonus
    referrer.referral_bonus_earned += bonus

    # Create REFERRAL_BONUS transaction
    transaction = Transaction(
        user_id=referrer.id,
        amount=bonus,
        transaction_type=TransactionType.REFERRAL_BONUS,
        description=f"Referral bonus from {referee.username} (purchase: {purchase_amount} ZNC)"
    )
    db.add(transaction)
    db.commit()

    return bonus
```

**Integration in TokenService:**

```python
# app/services/token_service.py (generate_access_token)
def generate_access_token(...):
    # ... existing token creation code ...

    # Award referral bonus (if applicable)
    from app.services.currency_service import CurrencyService
    CurrencyService.award_referral_bonus(
        referee_id=user_id,
        purchase_amount=cost,
        db=db
    )

    db.commit()
    return token, cost
```

**Integration in BundleService:**

```python
# app/services/bundle_service.py (purchase_bundle)
def purchase_bundle(...):
    # ... existing bundle purchase code ...

    # Award referral bonus (if applicable)
    from app.services.currency_service import CurrencyService
    CurrencyService.award_referral_bonus(
        referee_id=user.id,
        purchase_amount=bundle.total_price,
        db=db
    )

    db.commit()
    return result
```

### Transaction Type: REFERRAL_BONUS

**–§–∞–π–ª:** `app/models/transaction.py`

**–ù–æ–≤—ã–π enum value:**

```python
class TransactionType(str, Enum):
    DEPOSIT = "deposit"
    PURCHASE = "purchase"
    REFUND = "refund"
    REFERRAL_BONUS = "referral_bonus"  # Added in Phase 5
```

**Migration:** `alembic/versions/add_referral_bonus_transaction_type.py`

**–ü—Ä–∏–º–µ—Ä REFERRAL_BONUS transaction:**

```json
{
  "id": "uuid",
  "user_id": "referrer-uuid",
  "amount": "15.00",
  "transaction_type": "referral_bonus",
  "description": "Referral bonus from john_doe (purchase: 150.00 ZNC)",
  "payment_id": null,
  "created_at": "2025-11-19T..."
}
```

### API Endpoint: GET /api/v1/users/me/referrals

**–§–∞–π–ª:** `app/api/v1/users.py`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Auth:** JWT required

**Response:**

```json
{
  "referral_code": "ABC123XYZ456",
  "total_referrals": 5,
  "qualifying_referrals": 3,
  "total_bonus_earned": 45.00,
  "referral_link": "http://localhost:8000/register?ref=ABC123XYZ456",
  "referred_users": [
    {
      "id": "uuid",
      "username": "john_doe",
      "email": "john@example.com",
      "joined_at": "2025-11-15T...",
      "has_made_qualifying_purchase": true
    },
    {
      "id": "uuid",
      "username": "jane_smith",
      "email": "jane@example.com",
      "joined_at": "2025-11-18T...",
      "has_made_qualifying_purchase": false
    }
  ]
}
```

**Implementation:**

```python
@router.get("/me/referrals")
async def get_referral_stats(
    current_user: User = Depends(get_current_active_user),
    db: Session = Depends(get_db)
):
    """Get referral statistics for current user."""
    # Get referred users
    referred_users = db.query(User).filter(
        User.referred_by_id == current_user.id
    ).all()

    # Count qualifying referrals (users who made purchase >100 ZNC)
    qualifying_count = 0
    referred_users_data = []

    for user in referred_users:
        # Check if user made qualifying purchase
        qualifying_purchase = db.query(Transaction).filter(
            Transaction.user_id == user.id,
            Transaction.transaction_type == TransactionType.PURCHASE,
            Transaction.amount <= Decimal("-100.00")  # Negative for purchase
        ).first()

        has_qualified = qualifying_purchase is not None
        if has_qualified:
            qualifying_count += 1

        referred_users_data.append({
            "id": str(user.id),
            "username": user.username,
            "email": user.email,
            "joined_at": user.created_at.isoformat(),
            "has_made_qualifying_purchase": has_qualified
        })

    # Build referral link
    from app.config import settings
    referral_link = f"{settings.BACKEND_URL}/register?ref={current_user.referral_code}"

    return {
        "referral_code": current_user.referral_code,
        "total_referrals": len(referred_users),
        "qualifying_referrals": qualifying_count,
        "total_bonus_earned": float(current_user.referral_bonus_earned),
        "referral_link": referral_link,
        "referred_users": referred_users_data
    }
```

### Tests: test_referral_system.py

**–§–∞–π–ª:** `tests/test_referral_system.py`
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:** 14 —Ç–µ—Å—Ç–æ–≤

**Test Classes:**

1. **TestReferralCodeGeneration** (3 tests)
   - `test_generate_unique_referral_code` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 12-char code
   - `test_referral_code_uniqueness` - –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å codes
   - `test_referral_code_collision_handling` - Retry –ø—Ä–∏ –∫–æ–ª–ª–∏–∑–∏–∏

2. **TestRegistrationWithReferralCode** (3 tests)
   - `test_register_with_valid_referral_code` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å referral code
   - `test_register_with_invalid_referral_code` - ValueError –ø—Ä–∏ invalid code
   - `test_register_without_referral_code` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–µ–∑ referral code (ok)

3. **TestReferralBonusAward** (4 tests)
   - `test_award_bonus_on_first_qualifying_purchase` - Bonus –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ >100 ZNC
   - `test_no_bonus_on_small_purchase` - –ù–µ—Ç bonus –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ ‚â§100 ZNC
   - `test_no_bonus_on_second_purchase` - –ù–µ—Ç bonus –Ω–∞ –≤—Ç–æ—Ä—É—é –ø–æ–∫—É–ø–∫—É
   - `test_no_bonus_if_user_not_referred` - –ù–µ—Ç bonus –µ—Å–ª–∏ user –Ω–µ –±—ã–ª referred

4. **TestReferralStatsAPI** (2 tests)
   - `test_get_referral_stats_no_referrals` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
   - `test_get_referral_stats_with_referrals` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏

5. **TestReferralIntegration** (2 tests)
   - `test_token_purchase_triggers_referral_bonus` - Token purchase ‚Üí bonus
   - `test_bundle_purchase_triggers_referral_bonus` - Bundle purchase ‚Üí bonus

**Test Coverage:** 100% –¥–ª—è referral logic –∏ API endpoints

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. create_token_without_charge() Method

**–ü—Ä–æ–±–ª–µ–º–∞:** Bundle purchase —Å–ø–∏—Å—ã–≤–∞–ª–∞ –±–∞–ª–∞–Ω—Å –¥–≤–∞–∂–¥—ã (bundle price + each token price)

**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (BundleService —É–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å–æ–º, TokenService —Å–æ–∑–¥–∞—ë—Ç —Ç–æ–∫–µ–Ω—ã)
- Atomic transaction (–æ–¥–∏–Ω commit –¥–ª—è –≤—Å–µ–π –ø–æ–∫—É–ø–∫–∏ bundle)
- Easier testing (–º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å bundle purchase –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç token purchase)

### 2. Decimal Precision for Prices

**–†–µ—à–µ–Ω–∏–µ:** Decimal(10, 2) –¥–ª—è –≤—Å–µ—Ö price fields

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –¢–æ—á–Ω–æ—Å—Ç—å (–Ω–µ—Ç floating-point errors)
- Standard –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- Pydantic v2 —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç Decimal –∫–∞–∫ string –≤ JSON –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏

**Trade-offs:**
- Decimal slower —á–µ–º float (–Ω–æ —Ä–∞–∑–Ω–∏—Ü–∞ negligible –¥–ª—è –Ω–∞—à–∏—Ö –æ–±—ä—ë–º–æ–≤)
- JSON —Å–æ–¥–µ—Ä–∂–∏—Ç strings –≤–º–µ—Å—Ç–æ numbers (–Ω–æ —ç—Ç–æ correct –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤)

### 3. Computed Bundle Properties

**–†–µ—à–µ–Ω–∏–µ:** `savings` –∏ `price_per_token` –∫–∞–∫ @property, –ù–ï DB columns

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- No data duplication (calculated on-the-fly)
- Always consistent (no risk of stale data)
- Easier to maintain (change formula without migration)

**Trade-offs:**
- Cannot filter/sort by computed properties –≤ SQL (–Ω–æ –º—ã —ç—Ç–æ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º)

### 4. 12-Character Referral Codes

**–†–µ—à–µ–Ω–∏–µ:** Alphanumeric uppercase, 12 characters

**Rationale:**
- **–î–ª–∏–Ω–∞ 12:** Balance between uniqueness (36^12 codes) –∏ usability (–∫–æ—Ä–æ—á–µ = –ª–µ–≥—á–µ –≤–≤–æ–¥–∏—Ç—å)
- **Uppercase only:** Easier typing (no Shift key), easier reading (no l vs I confusion)
- **Alphanumeric:** Standard charset, URL-safe

**Collision Handling:** Retry logic (max 100 attempts, probability of failure ~0%)

### 5. First Purchase Only Bonus

**–†–µ—à–µ–Ω–∏–µ:** Referral bonus —Ç–æ–ª—å–∫–æ –∑–∞ –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É >100 ZNC

**Rationale:**
- **Anti-abuse:** Prevent gaming system (create multiple accounts, refer self)
- **Cost control:** Predictable bonus costs (10% of first purchase only)
- **Incentive alignment:** Encourage referring engaged users (who will make large first purchase)

**Trade-offs:**
- Less bonus for referrers (–Ω–æ —ç—Ç–æ acceptable –¥–ª—è cost control)
- Potential for abuse —á–µ—Ä–µ–∑ multiple accounts (–Ω–æ first purchase only mitigates this)

### 6. Automatic Bonus Award

**–†–µ—à–µ–Ω–∏–µ:** Integration –≤ TokenService –∏ BundleService

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- Automatic (no manual bonus claims)
- Immediate (bonus awarded instantly after purchase)
- Atomic (bonus award –≤ —Ç–æ–π –∂–µ transaction —á—Ç–æ –∏ purchase)

**Trade-offs:**
- Tight coupling (TokenService –∏ BundleService –∑–∞–≤–∏—Å—è—Ç –æ—Ç CurrencyService)
- Harder testing (–Ω—É–∂–Ω–æ mock CurrencyService –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å real DB)

---

## Database Migrations

### Migration 1: add_bundles_table

**–§–∞–π–ª:** `alembic/versions/..._add_bundles_table.py`

**Changes:**
- Create `token_bundles` table
- Add indexes: `ix_token_bundles_is_active`

**SQL:**
```sql
CREATE TABLE token_bundles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    token_count INTEGER NOT NULL,
    duration_hours INTEGER NOT NULL,
    scope VARCHAR(50) NOT NULL DEFAULT 'full',
    discount_percent NUMERIC(5, 2) NOT NULL,
    base_price NUMERIC(10, 2) NOT NULL,
    total_price NUMERIC(10, 2) NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX ix_token_bundles_is_active ON token_bundles (is_active);
```

**Downgrade:** Drop table and indexes

### Migration 2: add_referral_fields

**–§–∞–π–ª:** `alembic/versions/..._add_referral_fields.py`

**Changes:**
- Add `referral_code` column to users (VARCHAR 12, UNIQUE, NOT NULL)
- Add `referred_by_id` column to users (UUID FK, nullable)
- Add `referral_bonus_earned` column to users (NUMERIC 10,2, NOT NULL, DEFAULT 0.00)
- Add indexes: `ix_users_referral_code`, `ix_users_referred_by_id`
- Add foreign key: `fk_users_referred_by_id`

**SQL:**
```sql
-- Add columns
ALTER TABLE users
ADD COLUMN referral_code VARCHAR(12) UNIQUE NOT NULL,
ADD COLUMN referred_by_id UUID,
ADD COLUMN referral_bonus_earned NUMERIC(10, 2) NOT NULL DEFAULT 0.00;

-- Add foreign key
ALTER TABLE users
ADD CONSTRAINT fk_users_referred_by_id
FOREIGN KEY (referred_by_id) REFERENCES users (id) ON DELETE SET NULL;

-- Add indexes
CREATE INDEX ix_users_referral_code ON users (referral_code);
CREATE INDEX ix_users_referred_by_id ON users (referred_by_id);
```

**Downgrade:** Drop columns and constraints

### Migration 3: add_referral_bonus_transaction_type

**–§–∞–π–ª:** `alembic/versions/..._add_referral_bonus_transaction_type.py`

**Changes:**
- Add `referral_bonus` enum value to TransactionType

**SQL:**
```sql
ALTER TYPE transactiontype ADD VALUE 'referral_bonus';
```

**Note:** Enum values cannot be removed in PostgreSQL, so downgrade –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è

---

## Testing

### Test Statistics

**Total tests:** 208 (–±—ã–ª–æ 174)
**New tests:** 34 (20 bundles + 14 referrals)
**Coverage:** 85%+ (–≤—Å–µ –Ω–æ–≤—ã–µ features –ø–æ–∫—Ä—ã—Ç—ã)

### Test Files

1. **tests/test_bundles.py** - 20 tests
   - Model tests (3)
   - Service tests (14)
   - API tests (3)

2. **tests/test_referral_system.py** - 14 tests
   - Code generation (3)
   - Registration (3)
   - Bonus logic (4)
   - Stats API (2)
   - Integration (2)

### Test Philosophy

**Real Services (No Mocks):**
- PostgreSQL (test database: `zenzefi_test`)
- Redis (test instance on port 6379)

**Why?**
- Integration tests catch more bugs
- Confidence in production behavior
- Easier to write (no complex mocking)

**Trade-offs:**
- Slower (–Ω–æ –≤—Å—ë –µ—â—ë fast: 208 tests –≤ ~15 seconds)
- Requires Docker (PostgreSQL and Redis containers)

---

## Expected Business Impact

### Revenue Impact: +75-120%

**Token Bundles:**
- **Baseline scenario (+75% revenue):**
  - 30% of users switch to bundles
  - Average bundle size: 10 tokens (vs 1-2 tokens per purchase)
  - Impact: 30% √ó 5√ó volume = +150% volume ‚Üí +75% revenue (after discounts)

- **Optimistic scenario (+120% revenue):**
  - 50% of users switch to bundles
  - Average bundle size: 25 tokens (Team Pack popular)
  - Impact: 50% √ó 10√ó volume = +500% volume ‚Üí +120% revenue (after discounts)

**Referral System:**
- **User Acquisition:**
  - Baseline: +30% new users —á–µ—Ä–µ–∑ referrals
  - Optimistic: +50% new users
  - Cost: 10% bonus (–¥–µ—à–µ–≤–ª–µ –ø–ª–∞—Ç–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã)

- **Quality of Referred Users:**
  - Referred users more engaged (higher retention)
  - Higher conversion rate (social proof)

### Combined Impact: +105-170% Total Revenue

**Synergies:**
- Referred users more likely to buy bundles (see discounts immediately)
- Bundle buyers more likely to refer (have tokens to share)
- Viral loop: refer ‚Üí bonus ‚Üí buy bundle ‚Üí refer ‚Üí ...

---

## Future Improvements (Sprint 2-3)

### Sprint 2: Auto-Renewal + Gifting

**Token Auto-Renewal:**
- Subscription model (auto-renew before expiration)
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ renewal settings (auto/manual, notification)
- Impact: +20-30% retention (reduce churn)

**Token Gifting:**
- Send tokens to friends/colleagues
- Social sharing features (Twitter, Telegram)
- Impact: +15-25% viral growth

### Sprint 3: Loyalty Tiers + Promo Codes

**Loyalty Tiers:**
- Bronze/Silver/Gold based on total spent
- Tier benefits: extra discounts, priority support, early access
- Impact: +10-15% retention, +5-10% ARPU

**Promo Codes:**
- Discount codes for marketing campaigns
- One-time/multi-use, time-limited, usage limits
- Impact: +20-30% acquisition (marketing campaigns)

---

## Conclusion

Sprint 1 —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω –∑–∞ 3 –¥–Ω—è —Å –ø–æ–ª–Ω—ã–º —Ç–µ—Å—Ç–æ–≤—ã–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º (34 –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–∞).

**–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
- ‚úÖ Token Bundles —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º–∏ —Å–∫–∏–¥–∫–∞–º–∏ (10-20%)
- ‚úÖ Referral System —Å 10% bonus
- ‚úÖ Atomic transactions (no double charge)
- ‚úÖ Decimal precision (—Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å)
- ‚úÖ Comprehensive testing (208/208 tests passing)

**Expected Impact:**
- +75-120% revenue (bundles drive bulk purchases)
- +30-50% user acquisition (viral referrals)
- +105-170% total revenue potential

**Next Steps:**
- Sprint 2: Token Auto-Renewal + Gifting (8-10 –¥–Ω–µ–π)
- Sprint 3: Loyalty Tiers + Promo Codes (8-10 –¥–Ω–µ–π)
- v1.0.0: Full-featured monetization platform (Jan 2026)
